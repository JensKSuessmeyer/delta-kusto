name:  API Content

on:  workflow_dispatch

env:
  rg:  ---

jobs:
  deploy:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 5.0.x
    # See https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet-restore
    - name: Install dependencies
      run: dotnet restore code/DeltaKustoApi
    # See https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet-build
    - name: Build
      run: dotnet build code/DeltaKustoApi --configuration Release --no-restore
    # See https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet-publish
    - name: .NET Publish Web App
      run: dotnet publish code/DeltaKustoApi --configuration Release --no-build --output web-app
    # Zip published folder
    - name: Test
      run: |
        cd web-app
        zip api.zip *
    # Login
    - name: Azure Login
      run: az login --service-principal -u ${{ secrets.deploy_sp_id }} -p ${{ secrets.deploy_sp_secret }} --tenant ${{ secrets.tenant_id }}
    # Deploy Web App
    - name: Deploy
      run: |
        cd web-app
        az webapp up \
        --os-type linux \
        -r "DOTNETCORE|3.1" \
        -n "delta-kusto-api-dev-delta-kusto-pnctkmukjvu34" --plan "app-plan-delta-kusto-pnctkmukjvu34"